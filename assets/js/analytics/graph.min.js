HomioPi_assign("analytics.graph",{setup(t,e,i){return this.$graph=t,this.analyticId=e,this.maxRows=i||Math.round(t.outerWidth()),this.refresh(),$(document).on("mouseenter mouseleave mousemove touchmove",".graph-body",(t=>{this.eventMouseMove(t)})),$(document).on("mousedown touchstart",".graph-body",(t=>{this.eventMouseDown(t)})),$(document).on("mouseup touchend",".graph-body",(t=>{this.eventMouseUp(t)})),this},eventMouseDown(t){this.selection=[],this.selection_points=[]},eventMouseUp(t){4==Object.keys(this.selection).length&&4==Object.keys(this.selection_points).length&&this.paint(!0)},eventMouseMove(t){let e=clamp(0,HomioPi.data.pointer.x-this.$graph.offset().left,this.$graph.outerWidth()),i=clamp(0,HomioPi.data.pointer.y-this.$graph.offset().top,this.$graph.outerHeight());return this.moveCrosshairs(e,i),this.moveTooltip(e,i),!0===HomioPi?.data?.pointer?.down?.primary&&(this?.selection?.length<4?this.paintSelection(e,i,e,i):this.paintSelection(this?.selection?.x0,this?.selection?.y0,e,i)),this},refresh(){return this.$graphBody=this.$graph.closest(".graph-body"),this.$graphWrapper=this.$graph.closest(".graph-wrapper"),this.$graphContainer=this.$graph.closest(".graph-container"),this.$graphSelection=this.$graphContainer.find(".graph-selection"),this.$graphStepsHor=this.$graphContainer.find(".graph-area-hor .graph-axis-steps"),this.$graphStepsVer=this.$graphContainer.find(".graph-area-ver .graph-axis-steps"),this.$graphTooltip=this.$graphContainer.find(".graph-tooltip"),this.$graphLegend=this.$graphContainer.find(".graph-legend"),this.$graphCrosshairHor=this.$graphContainer.find(".graph-crosshair-hor"),this.$graphCrosshairVer=this.$graphContainer.find(".graph-crosshair-ver"),this},moveCrosshairs(t,e){return this.$graphCrosshairVer.css("left",t),this.$graphCrosshairHor.css("top",e),this},moveTooltip(t,e){this.$graphTooltip.css({left:t,top:e})},paint(t=!1){return this.clear(),this.paintInfo(t).then((()=>{this.paintGraph()})).catch((t=>{this.setStatus("error")})),this},paintInfo(t){return new Promise(((e,i)=>{HomioPi.api.call("analytic-json",{id:this.analyticId,max_rows:this.maxRows,selection:this.selection_points,debug:t}).then((t=>{try{this.rows=t.data.rows,this.size=t.data.size,this.manifest=t.data.manifest;let i=`${this.manifest.axes.x.title}`+(this.manifest.axes.x.unit.length>0?` (${this.manifest.axes.x.unit})`:""),a=`${this.manifest.axes.y.title}`+(this.manifest.axes.x.unit?.length>0?` (${this.manifest.axes.y.unit})`:"");HomioPi.analytics.graph.paintAxisTitles(i,a),HomioPi.analytics.graph.paintAxisSteps(),HomioPi.analytics.graph.paintTooltipItem(t.data.manifest.axes.x.title,"var(--text)","x",t.data.manifest.axes.x.unit,!1),$.each(t.data.manifest.columns,(function(i,a){let s=i.substring(0,1);HomioPi.analytics.graph.paintLegendItem(a.title,a.color,i),HomioPi.analytics.graph.paintTooltipItem(a.title,a.color,i,t.data.manifest.axes[s].unit),e(this)}))}catch(t){}})).catch((t=>{i(this)}))}))},paintSelection(t=null,e=null,i=null,a=null){t=clamp(0,t,this.$graph.outerWidth()),e=clamp(0,e,this.$graph.outerHeight()),i=clamp(0,i,this.$graph.outerWidth()),a=clamp(0,a,this.$graph.outerHeight()),x0_relative=round(t/this.$graph.outerWidth()*100,5),y0_relative=round(e/this.$graph.outerHeight()*100,5),x1_relative=round(i/this.$graph.outerWidth()*100,5),y1_relative=round(a/this.$graph.outerHeight()*100,5);let s=Math.min(x0_relative,x1_relative),h=Math.min(y0_relative,y1_relative),o=Math.max(x0_relative,x1_relative),r=Math.max(y0_relative,y1_relative);if(this.$graphSelection.css({top:h+"%",left:s+"%",height:r-h+"%",width:o-s+"%"}),null==t||null==e||null==i||null==a)return!1;this.selection={x0:t,y0:e,x1:i,y1:a},this.selection_points={x0:s/100*this?.size?.dif_x+this?.size?.min_x||null,y0:(100-h)/100*this?.size?.dif_y+this?.size?.min_y||null,x1:o/100*this?.size?.dif_x+this?.size?.min_x||null,y1:(100-r)/100*this?.size?.dif_y+this?.size?.min_y||null}},clearSelection(){this.selection=[],this.selection_points=[],this.paintSelection()},toggleView(){return!this.$graphBody.hasClass("popup")?this.$graphBody.popupCreate():this.$graphBody.popupDismantle(),HomioPi.analytics.graph.paint(),this},toggleStepsVisibility(){let t="false"==this.$graphContainer.attr("data-steps-visible");return this.$graphContainer.attr("data-steps-visible",t),this},paintGraph(){return this.setStatus("loading"),new Promise(((t,e)=>{HomioPi.api.call("analytic-graph",{id:this.analyticId,max_rows:this.maxRows,selection:this.selection_points}).then((t=>{this.setContent(t.data.svg),$.each(t.data.manifest.columns,(function(t,e){$(`.graph-line[data-column="${t}"]`).css({stroke:e.color,fill:e.color})})),this.setStatus("loaded").refresh()})).catch((t=>{this.setStatus("error")}))}))},paintAxisSteps(){let t=this.rows.length,e="",i="",a=Math.max(Math.floor(this.$graphStepsHor.outerWidth()/50),3),s=Math.max(Math.floor(this.$graphStepsVer.outerHeight()/50),3);for(let i=0;i<a;i++){let s=Math.floor(i/a*t);void 0!==this.rows[s]?.x_formatted&&(e+=`<span class="graph-axis-step text-monospace text-vertical">${this.rows[s].x_formatted}</span>`)}this.$graphStepsHor.html(e);let h=3;void 0!==this.manifest?.axes?.y?.decimals&&(h=this.manifest?.axes?.y?.decimals);for(let t=0;t<s;t++){i+=`<span class="graph-axis-step text-monospace">${(t/(s-1)*this?.selection?.dif_y+this?.selection?.min_y).toFixed(h)}</span>`}return this.$graphStepsVer.html(i),this},paintAxisTitles:(t,e)=>{let i=$(".graph-container");return void 0!==t&&i.find(".graph-area-hor .graph-axis-title").text(t),void 0!==e&&i.find(".graph-area-ver .graph-axis-title").text(e),this},paintTooltipItem(t,e,i,a,s=!0){let h=$(".graph-tooltip-item.template").clone().removeClass("template");h.find(".graph-tooltip-item-column").text(t),h.find(".graph-tooltip-item-value").css("color",e),h.find(".graph-tooltip-item-unit").text(a),h.attr("data-column",i),h.attr("data-sortable",s).toggleClass("text-muted",!s),h.appendTo(this.$graphTooltip)},paintLegendItem(t,e,i){return!0;let a=$(".graph-legend"),s=$(".graph-legend-item.template").clone().removeClass("template");s.find(".graph-legend-item-icon").css("background",e),s.find(".graph-legend-item-main").text(t),s.attr("data-column",i),s.appendTo(a)},setContent(t){return this.$graph.html(t),this},setStatus(t){return this.$graphContainer.attr("data-status",t),this},clear(){return this.setContent(""),this.clearSelection(),this.$graphTooltip.find(".graph-tooltip-item:not(.template)").remove(),this.$graphLegend.find(".graph-legend-item:not(.template)").remove(),this}}),$(document).on("close dismantle",".graph-container.popup",(function(){$('.graph-sidebar .btn[data-graph-action="toggle_view"]').removeClass("active")})),$(document).on("change",".graph-legend-item",(function(){return!0;let t=$(".graph"),e=$(this),i=e.attr("data-column"),a=e.hasClass("active");t.find(`[data-column="${i}"]`).toggleClass("inactive",!a)})),$(document).on("mouseenter mouseleave mousemove touchmove",".graph-body",(function(t){return!0;let e=$(".graph-container"),i=$(".graph"),a=$(".graph-tooltip"),s=e.find(".graph-target"),h=HomioPi.analytics.graph.data("size"),o=HomioPi.analytics.graph.data("rows"),r=HomioPi.analytics.graph.data("manifest"),n=clamp(0,mouseY-i.offset().top,i.outerHeight()),l=clamp(0,mouseX-i.offset().left,i.outerWidth());if(mouseDown)try{let t=HomioPi.analytics.graph.data("selection");void 0===t||t.length<4?HomioPi.analytics.graph.paintSelectionFrame(l,n,l,n):HomioPi.analytics.graph.paintSelectionFrame(t.x0,t.y0,l,n)}catch(t){}$graphCrosshairHor.css("top",n),$graphCrosshairVer.css("left",l);let p=clamp(0,(mouseX-i.offset().left)/i.outerWidth()*100,100);clamp(0,(mouseY-i.offset().top)/i.outerHeight()*100,100);if(void 0===h||void 0===o)return!1;let g=h.min_x+p/100*h.dif_x,m=null,c=0,d=o.length;for(;c<d;)void 0!==o[c+1]&&g>=o[c].x&&g<=o[c+1].x&&(m=o[c]),++c;if(null===m)return;let u=(1-(Math.max(...m.y)-h.min_y)/h.dif_y)*i.outerHeight(),f=(m.x-h.min_x)/h.dif_x*i.outerWidth();s.css({top:u,left:f}),a.find(".graph-tooltip-item:not(.template)").each((function(){let t,e=$(this),i=e.attr("data-column"),a=i.substring(0,1);i=i.substring(1);let s=3;if(void 0!==r?.axes[a]?.decimals&&(s=r?.axes[a]?.decimals),"x"==a)t=m.x_formatted;else{if(void 0===m[a][i])return!0;t=m[a][i].toFixed(s)}e.attr("data-value",t).find(".graph-tooltip-item-value").text(t)})),a.find('.graph-tooltip-item:not([data-sortable="false"])').sort((function(t,e){return $(t).attr("data-value")==$(e).attr("data-value")?$(t).find(".graph-tooltip-item-column").text()>$(e).find(".graph-tooltip-item-column").text()?1:-1:$(t).attr("data-value")<$(e).attr("data-value")?1:-1})).appendTo(a)})),$(document).on("HomioPi.load",(function(){if("analytics/graph"==HomioPi.page.current()){let t=urlParam("id");HomioPi.analytics.graph.setup($(".graph"),t).paint()}}));