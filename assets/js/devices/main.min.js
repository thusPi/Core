var updateValuesTimeout;function loadDeviceSearchResults(e){let t=e.find('.input[data-type="search"]'),a=e.attr("data-search-handler"),i=t.val(),o=`${thusPi.data.webroot}/assets/device_handlers/public/${a}/search.php?id=${e.attr("data-id")}&value=${i}`;t.parent().showLoading(),$.get(o,(function(e){t.parent().hideLoading();try{if(1!=(e=JSON.parse(e)).success)throw e.message;t.clearResults(),$.each(e.results,(function(e,a){t.appendResult(a.value,a.title,a.title,a.description,a.thumbnail)}))}catch(e){sendMessage(l("generic.error"),[],!0)}}))}function setDeviceValue(e,t,a){e.attr("data-value-updating-disabled","true");let i=e.attr("data-control-type"),o=e.find(".device-name"),s=o.text(),n=e.attr("data-id");e.attr("data-handler");o.showLoading(),void 0===a&&(a=t);let d={id:n,value:t,shown_value:a,force_set:e.attr("data-force-set")};thusPi.api.call("device-set-value",d).then((()=>{e.attr("data-value-updating-disabled","false"),o.hideLoading(),"toggle"==i?thusPi.message.send(thusPi.locale.translate(`devices.message.toggled_${t}_success`,[s])):thusPi.message.send(thusPi.locale.translate("devices.message.changed_success",[s,a]))})).catch((()=>{e.attr("data-value-updating-disabled","false"),o.hideLoading(),"toggle"==i?thusPi.message.error(thusPi.locale.translate(`devices.error.toggled_${t}_error`,[s])):thusPi.message.error(thusPi.locale.translate("devices.error.changed_error",[s,a]))}))}function toggleFavorite(e){"true"==e.attr("data-favorite")?e.attr("data-favorite","false"):e.attr("data-favorite","true"),saveFavoriteDevicesList()}function saveFavoriteDevicesList(){let e=[];$('.device[data-favorite="true"]').each((function(){e.push($(this).attr("data-id"))})),e=e.join(","),saveState("devices_favorite",e)}thusPiAssign("devices",{updateValuesLoop:(e=2500)=>{if("devices/main"!=thusPi.page.current())return!1;thusPi.devices.updateValues(),updateValuesTimeout=setTimeout((()=>{thusPi.devices.updateValuesLoop(e)}),e)},updateValues:()=>{thusPi.api.call("devices-get-values",{}).then((e=>{$.each(e.data,(function(e,t){const a=$(`.device[data-id="${e}"]`);return 0==a.length||(a.attr("data-value")==t.value||("true"==a.attr("data-value-updating-disabled")||(a.find(".device-control").value(t.value,t.shown_value),a.find(".device-name").text(t.name),void a.attr("data-value",t.value))))}))}))}}),$(document).on("thusPi.ready",(()=>{"devices/main"!=thusPi.page.current()&&clearTimeout(updateValuesTimeout),thusPi.devices.updateValuesLoop()})),$(document).ready((function(){$(".range-thumb").on("touchstart",(function(){$(this).siblings(".range-tooltip").css("opacity",1)})).on("touchend",(function(){$(this).siblings(".range-tooltip").css("opacity",0)}))})),$(document).on("input",'.device-control[data-type="range"]',(function(){$(this).parents(".device").attr("data-value-updating-disabled","true")})),$(document).on("click",".categories-list-row",debounce((function(){let e=[];$(".categories-list-row").find(".category-button").each((function(){$(this).hasClass("active")||e.push($(this).attr("data-category"))})),thusPi.users.currentUser.setSetting("devices_inactive_categories",e).then((()=>{thusPi.page.reload()})).catch()}),500)),$(document).on("thusPi.search_value_change",'.device .input[data-type="search"]',(function(){let e=$(this);setDeviceValue(e.parents(".device"),e.getValue(),e.getShownValue())})),$(document).on("change",'.device .device-control:not([data-type="search"])',(function(){let e=$(this),t=e.parents(".device"),a=e.value();setDeviceValue(t,a,a)}));