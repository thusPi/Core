thusPiAssign("recordings.graph",{setup(t,e,i){this.$graph=t,this.$graphContainer=t.closest(".graph-container"),this.$selection=this.$graphContainer.find(".graph-selection"),this.$crosshairHor=this.$graphContainer.find(".graph-crosshair.graph-crosshair-hor"),this.$crosshairVer=this.$graphContainer.find(".graph-crosshair.graph-crosshair-ver"),this.$tooltip=this.$graphContainer.find(".graph-tooltip"),this.$highlight=this.$graphContainer.find(".graph-highlight"),this.$targetHighlight=this.$graphContainer.find(".graph-target"),this.recordingId=e,this.maxRows=i,this.curveSmoothing=.1,this._fetchRows().then((()=>{this._paintRows(this.rows)}))},drawInterval(t){this._fetchRows(t).then((()=>{this._paintRows(this.rows)}))},selectPeriod(t){const e=new Date;switch(t){case"hour":return this.drawPeriod((new Date).setHours(e.getHours(),0,0,0),(new Date).setHours(e.getHours()+1,0,0,0));case"day":return this.drawPeriod(new Date((new Date).setDate(e.getDate())).setHours(0,0,0),new Date((new Date).setDate(e.getDate()+1)).setHours(0,0,0));case"week":return this.drawPeriod(new Date((new Date).setDate(e.getDate()-e.getDay())).setHours(0,0,0),new Date((new Date).setDate(e.getDate()-e.getDay()+6)).setHours(0,0,0));case"month":return this.drawPeriod(new Date((new Date).setMonth(e.getMonth())).setHours(0,0,0),new Date((new Date).setMonth(e.getMonth()+1)).setHours(0,0,0));case"year":return this.drawPeriod(new Date((new Date).setFullYear(e.getFullYear(),0,1)).setHours(0,0,0),new Date((new Date).setFullYear(e.getFullYear()+1,0,1)).setHours(0,0,0))}},drawPeriod(t,e){const i=Math.floor(t/1e3),s=Math.floor(e/1e3);let a=[];const r=this.rows.length;let o=0;for(;o<r;)this.rows[o].x<i||this.rows[o].x>s||a.push(this.rows[o]),++o},moveCrosshairs(t,e){const i=this._calculateRelativePixelsFromPixels(t,"x"),s=this._calculateRelativePixelsFromPixels(e,"y");this.$crosshairVer.css("left",i+"px"),this.$crosshairHor.css("top",s+"px")},updateTooltip(t,e){if(!isSet(this.size))return;const i=this._calculateRelativePixelsFromPixels(t,"x"),s=this._calculateRelativePixelsFromPixels(e,"y"),a=this._calculateValueFromRelativePixels(i,"x"),r=this.rows.length;let o,h=0;for(;h<r;)if(isSet(this.rows[h+1])){if(!(a<this.rows[h].x||a>this.rows[h+1].x)){o=h;break}++h}else++h;if(!isSet(o))return void this.$tooltip.hide();const n=this.rows[o],l=this.rows[o+1];this._drawHighlight(this._calculateRelativePixelsFromValue(n.x,"x"),this._calculateRelativePixelsFromValue(l.x,"x")),this.$tooltip.empty(),$.each(n.y,((t,e)=>{const i=thusPi.template.get(".graph-tooltip-item"),s=e.toFixed(this.manifest.axes.y.decimals);i.find(".graph-tooltip-item-column").text(this.manifest.columns["y"+t].title).css("color",this.manifest.columns["y"+t].color),i.find(".graph-tooltip-item-value").text(s),i.find(".graph-tooltip-item-unit").text(this.manifest.axes.y.unit),i.appendTo(this.$tooltip)}));const u=thusPi.template.get(".graph-tooltip-item");u.find(".graph-tooltip-item-column").text(this.manifest.axes.x.title),u.find(".graph-tooltip-item-value").text(n.x_formatted),u.prependTo(this.$tooltip),this.$tooltip.css({top:s+"px",left:(i<this.$graph.outerWidth()/2?i:i-this.$tooltip.outerWidth())+"px"}).show(),this.$tooltip.toggleClass("tooltip-align-right")},_drawHighlight(t,e){this.$highlight.css({left:Math.min(t,e),width:Math.abs(e-t)})},async _fetchRows(t="recording"){return this._clear(),this._setStatus("loading"),new Promise(((e,i)=>{thusPi.api.call("recordings/json",{id:this.recordingId,max_rows:this.maxRows,interval:t},!0).then((t=>{this.rows=t.data.rows,this.manifest=t.data.manifest,e()})).catch((t=>{this._setStatus("error")}))}))},_paintRows(t){const e=t.length;let i="",s={},a={min_x:null,max_x:null,min_y:null,max_y:null},r=0;for(;r<e;){(null===a.min_x||this.rows[r].x<a.min_x)&&(a.min_x=t[r].x),(null===a.max_x||this.rows[r].x>a.max_x)&&(a.max_x=t[r].x);const e=Math.min(...t[r].y);(null===a.min_y||e<a.min_y)&&(a.min_y=e);const i=Math.max(...t[r].y);(null===a.max_y||i>a.max_y)&&(a.max_y=i),++r}a.dif_x=a.max_x-a.min_x,a.dif_y=a.max_y-a.min_y,this.size=a;let o=0;for(;o<e;){const e=t[o].y.length;let i=0;for(;i<e;)if(0!==o)isSet(s[i])?(s[i]+=this._calculateBezierPath(o,i,a),++i):++i;else{const t=this._calculatePointCoordinates(o,i,a);s[i]=`M ${t.x} ${t.y}`,++i}++o}$.each(s,((t,e)=>{const s=this.manifest.columns["y"+t]?.color||null;i+=`<path class="graph-line" ${isSet(s)?`style="stroke: ${s};"  `:""}data-column-index="${t}" d="${e.trim()}" fill="transparent"></path>`})),this.$graph.html(`<svg width="100%" height="100%" viewBox="0 0 1000 1000" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">${i}</svg>`),setTimeout((()=>{this._setStatus("ready")}),0)},_calculateLineProperties(t,e){const i=e.x-t.x,s=e.y-t.y;return{length:Math.sqrt(Math.pow(i,2)+Math.pow(s,2)),angle:Math.atan2(s,i)}},_calculateBezierPath(t,e,i){const s=[this._calculatePointCoordinates(t-2,e,i),this._calculatePointCoordinates(t-1,e,i),this._calculatePointCoordinates(t,e,i),this._calculatePointCoordinates(t+1,e,i)],a=this._calculateControlPoint(s[0],s[1],s[2]),r=this._calculateControlPoint(s[1],s[2],s[3],!0);return`C ${a.x},${a.y} ${r.x},${r.y} ${s[2].x},${s[2].y}`},_calculateControlPoint(t,e,i,s){t=t||e,i=i||e;const a=this._calculateLineProperties(t,i),r=a.angle+(s?Math.PI:0),o=a.length*this.curveSmoothing;return{x:e.x+Math.cos(r)*o,y:e.y+Math.sin(r)*o}},_calculatePointCoordinates(t,e,i){const s=this.rows[t];if(!isSet(s))return;const a=s.x;if(!isSet(a))return;const r=s.y[e];return isSet(r)?{x:(a-i.min_x)/i.dif_x*1e3,y:1e3-(r-i.min_y)/i.dif_y*1e3}:void 0},_calculateRelativePixelsFromPixels(t,e){return"x"==e?clamp(0,t-this.$graph.offset().left,this.$graph.outerWidth()):"y"==e?clamp(0,t-this.$graph.offset().top,this.$graph.outerHeight()):null},_calculatePixelsFromRelativePixels(t,e){return"x"==e?this.$graph.offset().left+t:"y"==e?this.$graph.offset().top+t:null},_calculateValueFromRelativePixels(t,e){return isSet(this.size)?"x"==e?this.size.min_x+t/this.$graph.outerWidth()*this.size.dif_x:"y"==e?this.size.min_y+t/this.$graph.outerHeight()*this.size.dif_y:null:null},_calculateRelativePixelsFromValue(t,e){return isSet(this.size)?"x"==e?clamp(0,(t-this.size.min_x)/this.size.dif_x*this.$graph.outerWidth()):"y"==e?clamp(0,(t-this.size.min_y)/this.size.dif_y*this.$graph.outerHeight()):null:null},_setStatus(t){return this.$graphContainer.attr("data-status",t),this},_clear(){return this.$graph.html(""),this}}),$(document).on("thuspi.ready",(function(){if("recordings/graph"!=thusPi.page.current())return!1;const t=Math.max(500,1.5*$(".graph").outerWidth());thusPi.recordings.graph.setup($(".graph"),urlParam("id"),t)})),$(document).on("mousenter mouseleave mousemove",".graph",throttle((function(){thusPi.recordings.graph.moveCrosshairs(thusPi.data.pointer.x,thusPi.data.pointer.y),thusPi.recordings.graph.updateTooltip(thusPi.data.pointer.x,thusPi.data.pointer.y),thusPi.data.pointer.btnDown.primary&&thusPi.recordings.graph.drawSelection(thusPi.data.pointer.x,thusPi.data.pointer.y)}),10));