$(document).on("thuspi.ready",(function(){if("recordings/graph"!=thusPi.page.current())return!1;$(".graph-canvas").get(0).getContext("2d")})),thusPiAssign("recordings.graph",{async setup(t,e,a){this.canvas=t.get(0),this.ctx=this.canvas.getContext("2d"),this.recordingId=e,this.maxRows=a,this._paint(await this._fetchRows())},_fetchRows(){return this._clear(),this._setStatus("loading"),new Promise(((t,e)=>{thusPi.api.call("recordings/json",{id:this.recordingId,max_rows:this.maxRows},!0).then((e=>{this.dataSets=e.data.datasets,this.manifest=e.data.manifest,t()})).catch((t=>{this._setStatus("error")}))}))},_paint(){const t=this.manifest;Chart.Tooltip.positioners.cursor=function(t,e){return e};let e={type:"line",data:{labels:[...this.dataSets[0].keys()],datasets:[]},options:{scales:{x:{beginAtZero:!1,ticks:{color:getCSSVariable("--text"),callback:function(t,e,a){return thusPi.locale.formatDate(thusPi.recordings.graph.dataSets[0][e].x,"full","full")||"?"}},grid:{color:getCSSVariable("--tertiary")}},y:{ticks:{color:getCSSVariable("--text")},grid:{color:getCSSVariable("--tertiary")}}},events:["mousemove","mouseenter","mouseout"],plugins:{legend:{display:!1},tooltip:{enabled:!1,position:"cursor",external:thusPi.recordings.graph.tooltip.handler}},interaction:{intersect:!1,mode:"index"}}};$.each(this.dataSets,(function(a,s){if(!isSet(t.datasets[a]))return!0;let r=rgbaToArray(getCSSVariable(t.datasets[a].color));const i=arrayToRgba([r[0],r[1],r[2],.5]),o=arrayToRgba([r[0],r[1],r[2],1]);isSet(t.datasets[a].mirrored)&&!0===t.datasets[a].mirrored&&$.each(s,(function(t,e){s[t]={x:e.x,y:-e.y}})),e.data.datasets.push({label:t.datasets[a].title,data:s,backgroundColor:o,pointRadius:1.5,pointHoverRadius:2.5,borderColor:i,borderWidth:1})})),new Chart(this.ctx,e)},tooltip:{handler(t){const{chart:e,tooltip:a}=t,s=thusPi.recordings.graph.tooltip.jQueryObject(e);if(0===a.opacity)return void s.css("opacity",0);const{offsetLeft:r,offsetTop:i}=e.canvas;s.css({left:r+a.caretX+"px",top:i+a.caretY+"px"}),a.body&&($.each(a.dataPoints,(function(t,e){const a=thusPi.recordings.graph.manifest,r=a?.axes?.y?.decimals||0,i=e.parsed?.y?.toFixed(r);s.find(".tile-content").append(`<div class="graph-tooltip-item"><span class="graph-tooltip-item-key" style="color: ${a?.datasets[t]?.color};">${e.dataset.label}</span><span class="graph-tooltip-item-value">${i}</span></div>`)})),e.canvas.parentNode.appendChild(s.get(0)))},jQueryObject(t){let e=$(t.canvas.parentNode.querySelector("div"));return e.children().empty(),e.length||(e=$('<div class="graph-tooltip tile tile-small"><h3 class="tile-title"></h3><div class="tile-content"></div></div>')),e}},_setStatus(t){return this},_clear(){return this}}),$(document).on("thuspi.ready",(function(){if("recordings/graph"!=thusPi.page.current())return!1;const t=$(".graph-container"),e=$(".graph-canvas"),a=Math.round(.5*t.outerWidth());thusPi.recordings.graph.setup(e,urlParam("id"),a)}));