thusPiAssign("flows.editor",{setup(){this.blockly._setup(),isSet(thusPi.data.flows.blocks)&&this.blockly._registerBlocks(thusPi.data.flows.blocks)},blockly:{_setup(){this.workspace=Blockly.inject("thuspi-flow-editor",{toolbox:this._getToolbox(),renderer:this._getRenderer(),theme:this._getTheme(),trashcan:!0}).addChangeListener(this._workspaceToCode())},_workspaceToCode(){Blockly.JavaScript.workspaceToCode(this.workspace)},_getRenderer:()=>"thuspi_renderer",_getTheme:()=>({base:Blockly.Themes.Classic,componentStyles:{workspaceBackgroundColour:getCSSVariable("--secondary"),toolboxBackgroundColour:"blue",toolboxForegroundColour:"red",flyoutBackgroundColour:"cyan",flyoutForegroundColour:"green",flyoutOpacity:1,scrollbarColour:"orange",insertionMarkerColour:"yellow",insertionMarkerOpacity:.3,scrollbarOpacity:.4,cursorColour:"pink"}}),_getToolbox:()=>({contents:[{kind:"category",name:"Core",contents:[{kind:"block",type:"controls_if"},{kind:"block",type:"logic_compare"},{kind:"block",type:"devices_numeric_value"}]}]}),_registerBlocks(e){let o=[];$.each(e,(function(e,t){t.id=e;const r=thusPi.flows.editor.blockly.blockConverter._convert(t);if(!1===r)return!0;o.push(r)})),Blockly.common.defineBlocksWithJsonArray(o)},blockConverter:{_convert(e){let o=[];if(!isSet(e.id))return!1;o={type:e.id,message:this._convertContent(e.content)},isSet(e.parameters)&&$.each(e.parameters,(function(e,t){const r=thusPi.flows.editor.blockly.blockConverter._convertParameter(t);if(!1===r)return!0;o[`args${e}`]=r}))},_convertContent(e){if(e.indexOf("%")<0)return e;return e.replace(/(%\d+)+/g,(function(e){return"%"+(parseInt(e.substring(1))+1)}))},_convertParameter(e){let o={name:e.name,type:"input_value",check:this._convertParameterType(e?.type)};if(isSet(e.options_id)){o.type="field_dropdown",o.options=[];const t=thusPi.data.flows.options[e.options_id]||void 0;if(!isSet(t))return!1;$.each(t,(function(e,t){if(!isSet(t.value))return!0;o.options.push([t.text||t.value,t.value])}))}return o},_convertParameterType(e=null){switch(e){case"number":return"Number";case"boolean":return"Boolean";case"array":return"Array";case"color":return"Colour";default:return"String"}}}}}),$(document).on("thuspi.ready",(function(e,o){"flows/manage"==o.page&&thusPi.flows.editor.setup()}));